---
layout: post
title: 操作系统-内核级线程
date: 2018-11-10
tags: 笔记 操作系统
---

# 内核级线程

多核用的是同一套映射（mmu）

多个线程可以使用多个核心 

用户级线程 操作系统看不到 无法使用设备



### 和用户级相比，核心级线程区别

- threadcreate是系统调用，内核管理tcb，内核负责切换线程
- 如何让切换成型 内核栈，tcb
  + 执行的代码仍然在用户态，还要进行函数调用
  + 一个栈到一套栈；两个栈到两套栈
  + 栈的切换变成从“个”到“套”

## 步骤整理

线程S的用户栈 一旦遇到中断 int 即进入到内核栈（利用中断进入内核）

在内核栈中 用到了 TCB

一旦完成切换 根据这个TCB切换到下一个线程T的TCB 

而线程T的TCB 中有对应的线程T的核心栈

线程T的核心栈中 关联着线程T的用户栈

IRET回到S用户栈

## 内核线程switch_tu的五段论

1. 中断入口：（进入切换）

   中断处理

2. 在中断处理中可能会组成阻塞（启动磁盘读 或 时钟中断）



 threadCreate函数

```
void THreadCreate(...)
{
    TCB tcb = get_free_page();//申请一段内存作为tcb
    //申请一段内存作为内核栈
    //传入用户栈
    //填写两个栈
    tcb.esp = krlstack;
    tcb.状态 = 就绪；
    tcb入队；
}
```



|            | 用户级线程 | 核心级线程 | 用户+核心级 |
| ---------- | ---------- | ---------- | ----------- |
| 利用多核   | 差         | 好         | 好          |
| 并发度     | 低         | 高         | 高          |
| 代价       | 小         | 大         | 中          |
| 内核改动   | 无         | 大         | 大          |
| 用户灵活性 | 大         | 小         | 大          |

